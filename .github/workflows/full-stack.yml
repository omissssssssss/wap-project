name: Full Stack CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  full-stack-test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Build & up Docker Compose (v2 syntax)
      - name: Build and start Docker Compose
        run: |
          docker compose up -d --build
          echo "Waiting for MySQL and Backend to be ready..."
          for i in {1..30}; do
            mysql_ready=$(docker exec mysql_db mysqladmin ping -uroot -proot | grep 'mysqld is alive' || true)
            backend_ready=$(curl -s http://localhost:5001/ || true)
            if [ ! -z "$mysql_ready" ] && [ ! -z "$backend_ready" ]; then
              echo "All services are ready!"
              break
            fi
            echo "Waiting for services... retry $i"
            sleep 2
          done

      # 4. Run Backend Test
      - name: Run Backend Test
        run: docker exec backend_service npm test

      # 5. Run Frontend Test
      - name: Run Frontend Test
        run: docker exec frontend_app npm test

      # 6. Tear down containers
      - name: Tear down
        run: docker compose down -v

      # 7. Success message
      - name: Success
        run: echo "âœ… Full stack React + Backend + MySQL setup success!"

