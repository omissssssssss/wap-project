name: Full Stack CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  full-stack-test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Build & Start Docker Compose
      - name: Build and start Docker Compose
        run: |
          docker compose up -d --build
          echo "Waiting for MySQL & Backend to be ready..."
          for i in {1..40}; do
            mysql_ready=$(docker exec mysql_db mysqladmin ping -uroot -proot 2>/dev/null | grep 'mysqld is alive' || true)
            backend_ready=$(curl -s http://localhost:5001/ | grep -v "Connection refused" || true)

            if [ ! -z "$mysql_ready" ] && [ ! -z "$backend_ready" ]; then
              echo "All services are ready!"
              break
            fi

            echo "Waiting for services... retry $i"
            sleep 3
          done

      # 4. Run Backend Test
      - name: Run Backend Tests
        run: |
          docker exec backend npm install
          docker exec backend npm test

      # 5. Run Frontend Test
      - name: Run Frontend Tests
        run: |
          docker exec frontend npm install
          docker exec frontend npm test

      # 6. Tear down containers
      - name: Tear down containers
        run: docker compose down -v

      # 7. Success message
      - name: CI Success
        run: echo "âœ… Full stack CI/CD: Backend + Frontend + MySQL test success!"


